#!/usr/bin/env bash

wall_dir="$HOME/Pictures/Backgrounds"
cache_dir="$HOME/.cache/thumbnails/bgselector"
blur_dir="$HOME/.cache/backgrounds/blurred"

mkdir -p "$cache_dir" "$blur_dir"

process_image() {
    local img_path="$1"
    [ ! -f "$img_path" ] && return

    local file_name=$(basename "$img_path")
    local thumb_path="$cache_dir/$file_name"
    local blur_path="$blur_dir/$file_name"

    if [ ! -f "$thumb_path" ]; then
        magick "$img_path" -strip -thumbnail x540^ -gravity center -extent 262x540 "$thumb_path"
    fi

    if [ ! -f "$blur_path" ]; then
        ffmpeg -loop 1 -i "$img_path" -vf "boxblur=64" -frames:v 1 -update 1 "$blur_path" -y -loglevel error
    fi
}

find "$wall_dir"/ -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) | while read -r img; do
    process_image "$img"
done

#inotifywait -m -e create -e moved_to --format '%w/%f' "$wall_dir" | while read -r new_img; do
#    if [[ "$new_img" =~ \.(jpg|jpeg|png|webp)$ ]]; then
#        process_image "$new_img"
#    fi
#done
